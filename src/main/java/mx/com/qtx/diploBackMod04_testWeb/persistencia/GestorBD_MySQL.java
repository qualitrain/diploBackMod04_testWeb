package mx.com.qtx.diploBackMod04_testWeb.persistencia;

import mx.com.qtx.diploBackMod04_testWeb.entidades.Persona;
import mx.com.qtx.diploBackMod04_testWeb.servicios.IGestorBD;

import java.sql.*;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

public class GestorBD_MySQL implements IGestorBD {
    private final String cadConexion;
    private final String usuarioBD;
    private final String passwordBD;

    public GestorBD_MySQL(String cadConexion, String usuarioBD, String passwordBD) {
        this.cadConexion = cadConexion;
        this.usuarioBD = usuarioBD;
        this.passwordBD = passwordBD;
    }

    public Connection getConexionBD() throws SQLException {
        try {
           return DriverManager.getConnection(this.cadConexion,this.usuarioBD,this.passwordBD);
        }
        catch (SQLException e) {
            throw e;
        }
    }

    public void desplegarPersonasConNombreyFecNac() throws SQLException {
        final String cadSQL = "SELECT id_persona, nombre, fecha_nacimiento FROM persona;";
        try(Connection con = this.getConexionBD()){
            try(Statement st = con.createStatement()){
                st.execute(cadSQL);
                try(ResultSet rs = st.getResultSet()){
                    while(rs.next()){
                       int id = rs.getInt("id_persona");
                       String nombre = rs.getString("nombre");
                       Date fechaNac = rs.getDate("fecha_nacimiento");

                       System.out.printf("%4d %-40s %s\n", id, nombre, fechaNac.toLocalDate());
                    }
                }
            }
        }
    }

    public List<Persona> getPersonasTodas() throws SQLException {
        final String cadSQL = "SELECT id_persona, nombre, direccion, fecha_nacimiento FROM persona;";
        List<Persona> lstPersonas = new ArrayList<>();

        try(Connection con = this.getConexionBD()){
            try(Statement st = con.createStatement()){
                st.execute(cadSQL);
                try(ResultSet rs = st.getResultSet()){
                    while(rs.next()){
                        int id = rs.getInt("id_persona");
                        String nombre = rs.getString("nombre");
                        Date fechaNac = rs.getDate("fecha_nacimiento");
                        String dir = rs.getString("direccion");

                        lstPersonas.add(new Persona(id,nombre,dir,fechaNac.toLocalDate()));
                     }
                }
            }
        }
        return lstPersonas;
    }

    public List<Persona> getPersonasNacidasEntre(LocalDate fecInf, LocalDate fecSup) throws SQLException {
        if (fecInf == null)
            throw new IllegalArgumentException("Fecha Inferior no puede ser nula");
        if (fecSup ==null)
            throw new IllegalArgumentException("Fecha Superior no puede ser nula");
        if(fecInf.isAfter(fecSup))
            throw new IllegalArgumentException("La fecha inferior del rango es mayor que la superior: " + fecInf + " > " + fecSup);

        final String cadSQL = "SELECT id_persona, nombre, direccion, fecha_nacimiento FROM persona " +
                              "WHERE fecha_nacimiento between ? and ?;";
        List<Persona> lstPersonas = new ArrayList<>();

        try(Connection con = this.getConexionBD()){
            try(PreparedStatement pst = con.prepareStatement(cadSQL)){

                pst.setDate(1,Date.valueOf(fecInf));
                pst.setDate(2,Date.valueOf(fecSup));
                try(ResultSet rs = pst.executeQuery()){
                    while(rs.next()){
                        int id = rs.getInt("id_persona");
                        String nombre = rs.getString("nombre");
                        Date fechaNac = rs.getDate("fecha_nacimiento");
                        String dir = rs.getString("direccion");

                        lstPersonas.add(new Persona(id,nombre,dir,fechaNac.toLocalDate()));
                    }
                }
            }
        }
        return lstPersonas;

    }

    public int insertarPersona(Persona persona) throws SQLException {

        if(personaInvalida(persona)){
            throw new IllegalArgumentException("registro de persona inv√°lido " +  persona);
        }
        if(personaYaExisteEnBD(persona.getIdPersona())){
            throw new IllegalArgumentException("Registro con id duplicado: " +  persona.getIdPersona());
        }
        final String cadSQL ="INSERT INTO persona (id_persona, nombre, direccion, fecha_nacimiento) " +
                    "VALUES (?, ?, ?, ?);";
        try(Connection con = this.getConexionBD()) {
            try (PreparedStatement pst = con.prepareStatement(cadSQL)) {
                pst.setInt(1, persona.getIdPersona());
                pst.setString(2,persona.getNombre());
                pst.setString(3, persona.getDireccion());
                pst.setDate(4, Date.valueOf(persona.getFechaNacimiento()));
                int nInserts = pst.executeUpdate();
                return nInserts;
            }
        }

    }

    private boolean personaYaExisteEnBD(int id) {
        /* todo
        Checar en la BD si ese id ya existe
         */
        return false;
    }

    private boolean personaInvalida(Persona persona) {
        if(persona.getIdPersona() < 0)
            return true;
        if(persona.getNombre() == null)
            return true;
        if(persona.getDireccion() == null)
            return true;
        if(persona.getFechaNacimiento() == null)
            return true;
        return false;
    }

    public Persona leerPersonaXID(int id) throws SQLException {
        final String cadSQL = "SELECT nombre, direccion, fecha_nacimiento FROM persona " +
                "where id_persona = ?;";
        try(Connection con = this.getConexionBD()){
            try(PreparedStatement pst = con.prepareStatement(cadSQL)){

                pst.setInt(1,id);
                try(ResultSet rs = pst.executeQuery()){
                    if(rs.next()){
                        Date fechaNacimiento = rs.getDate("fecha_nacimiento");
                        String nombre = rs.getString("nombre");
                        String direccion = rs.getString("direccion");

                        return new Persona(id,nombre,direccion,fechaNacimiento.toLocalDate());
                    }
                    else
                        return null;
                }
            }
        }
    }
}
